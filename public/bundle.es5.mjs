const e="parent-handshake-acknowledge",t="contentstorage-set-config",n="contentstorage-set-text-values",o="contentstorage-handshake-initiate",r="contentstorage-click-item-edit-btn",i="contentstorage-found-text-nodes",a=(e,t)=>{const n={type:e,payload:t};console.log("CDN Script: Sending message to parent:",n),window.parent.postMessage(n,"*")};let s=!1;const c=(e,t)=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent?.trim()){const n=t.find((t=>e.textContent.includes(t.text)));return void(n?((e,t)=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent){const n=e.parentElement;if(n?.hasAttribute("data-content-key")&&n.getAttribute("data-content-key")===t)return;const o=document.createElement("span");o.setAttribute("data-content-key",t),o.textContent=e.textContent,e.parentNode?.replaceChild(o,e)}})(e,n.contentKey):(e=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent){const t=e.parentElement;if(t?.hasAttribute("data-content-checked"))return;const n=document.createElement("span");n.setAttribute("data-content-checked","true"),n.textContent=e.textContent,e.parentNode?.replaceChild(n,e)}})(e))}if(e.nodeType===Node.ELEMENT_NODE){const t=e;if(t.hasAttribute("data-content-key")||t.hasAttribute("data-content-checked"))return}const n=Array.from(e.childNodes);for(const e of n)c(e,t)},d=e=>{if(!s){s=!0;try{e&&e?.length>0&&c(document.body,e);document.querySelectorAll("[data-content-key]").forEach((e=>{const t=e.dataset.contentKey;if(t){e.style.outline="1px solid #1791FF",e.style.position="relative";const n=document.createElement("div");n.setAttribute("id","contentstorage-element-label"),n.textContent=t,n.style.position="absolute",n.style.top="-15px",n.style.left="0px",n.style.color="#1791FF",n.style.fontSize="10px",n.style.zIndex="9999",n.style.pointerEvents="none";const o=(e=>{const t=document.createElement("button");t.type="button",t.style.width="30px",t.style.height="30px",t.style.position="absolute",t.style.top="-15px",t.style.right="-10px",t.style.cursor="pointer",t.style.border="1px solid #C0C0CA",t.style.backgroundColor="#EAF1F9",t.style.borderRadius="30px",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.padding="0px",t.style.color="#222225",t.style.zIndex="9999",t.onclick=t=>{t.stopPropagation(),t.preventDefault(),a(r,{contentKey:e})};const n="http://www.w3.org/2000/svg",o=document.createElementNS(n,"svg");o.setAttribute("xmlns",n),o.setAttribute("viewBox","0 0 20 20"),o.setAttribute("fill","currentColor"),o.setAttribute("width","16"),o.setAttribute("height","16");const i=document.createElementNS(n,"path");return i.setAttribute("d","M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"),o.appendChild(i),t.appendChild(o),t})(t);e.appendChild(n),e.appendChild(o)}}))}finally{s=!1}}};let l={highlightEditableContent:!1};const p=e=>{l={...e}},u=e=>!!e&&(!!e.isContentEditable||u(e.parentElement)),m=()=>{const e=[],t=!!document.querySelector('[contenteditable="true"]'),n=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const n=e.parentElement;if(!n||!e.textContent?.trim())return NodeFilter.FILTER_SKIP;let o=n;for(;o&&o!==document.body;){if(o.hasAttribute("data-content-key")||o.hasAttribute("data-content-checked"))return NodeFilter.FILTER_SKIP;o=o.parentElement}return(r=n)instanceof HTMLScriptElement||r instanceof HTMLStyleElement||r instanceof HTMLTextAreaElement||r instanceof HTMLOptionElement||"NOSCRIPT"===r.tagName?NodeFilter.FILTER_SKIP:((e,t=!1,n=!1)=>!("checkVisibility"in e)||e.checkVisibility({checkOpacity:t,checkVisibilityCSS:n}))(n)?t&&u(n)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP;var r}});let o;for(;o=n.nextNode();)e.push(o);return e};function h(e){if(e.nodeType!==Node.ELEMENT_NODE)return!1;const t=e;return t.hasAttribute("data-content-key")||t.hasAttribute("data-content-checked")}const y=(e,t)=>{let n=!1;const o=document.body,r=["contentstorage-element-label"],s=["style","class"],c=e.some((e=>"childList"===e.type&&Array.from(e.addedNodes).some(h)));for(const t of e){if("childList"===t.type){if(Array.from(t.addedNodes).some(h))continue}if(c&&"childList"===t.type){if(t.removedNodes.length>0&&0===t.addedNodes.length&&Array.from(t.removedNodes).every((e=>e.nodeType===Node.TEXT_NODE)))continue}if("attributes"===t.type&&s.includes(t.attributeName||"")){if(!t.target.hasAttribute("data-content-key"))continue}const e=t.target;if(e){let t=e.nodeType===Node.ELEMENT_NODE?e:e.parentElement;for(;t;){if(t.id&&r.includes(t.id)){n=!1;break}t=t.parentElement}if(t&&r.includes(t.id))continue}n=!0;break}if(n){t.disconnect();try{const e=m();e.map((e=>e.textContent||"")).length>0&&(a(i,e.map((e=>e.textContent||""))),console.log("Significant mutation detected. Processing and sending text nodes."))}catch(e){console.error("Error during DOM processing after mutation:",e)}finally{Promise.resolve().then((()=>{t.observe(o,g)})).catch((e=>{console.error("Error re-observing target node:",e)}))}}},g={childList:!0,subtree:!0,attributes:!0};!function(){const r=document.currentScript;if(!r)return void console.error("CDN Script: Could not determine the current script element. This is necessary to read URL parameters from the script's own URL. Ensure the script is loaded via a standard <script> tag.");const i=r.src;console.log(`CDN Script: Loaded from ${i}`);let s=null;try{s=new URL(i).searchParams.get("contentstorage-live-editor")}catch(e){return void console.error("CDN Script: Could not parse script URL. Ensure it's a valid URL.",e)}if(s)if(window.parent&&window.parent!==window){console.log("CDN Script: Running inside an iframe. Setting up communication with parent and initiating handshake.");const r=new MutationObserver(y);let i,c=!1;const u=o=>{if(o.source===window.parent&&o.data)if(o.data.type===e)c||(c=!0,console.log("CDN Script: Received handshake acknowledgment from parent:",o.data.payload),i=o.data.payload.data.config,p(i),console.log("INITIAL CONFIG",i),i.highlightEditableContent&&d(),console.log("Applied config:",o.data.payload),console.log("Started observing DOM for mutations"),r.observe(document.body,g),console.log("CDN Script: Received handshake acknowledgment from parent:",o.data.payload),m(),console.log("CDN Script: Parent communication handshake successful. Ready for further messages."));else if(c){if(console.log("CDN Script: Received further message from parent:",o.data),o.data.type===t&&p(o.data.payload.data),o.data.type===n){const e=o.data.payload.data,t=l.highlightEditableContent;console.log("shouldHighlight",t),t&&e?.length>0&&d(e),console.log("CDN Script: Received text values from parent:",e)}}else console.warn("CDN Script: Received message from parent before handshake was complete. Ignoring:",o.data);var i},m=()=>{i&&(clearTimeout(i),i=void 0)};window.addEventListener("message",u),a(o,`Hello from iframe script (editor param: ${s}). Initiating handshake.`),i=window.setTimeout((()=>{c||(console.warn("CDN Script: Parent communication handshake timed out. Parent did not respond or acknowledge correctly."),m())}),5e3)}else console.log("CDN Script: Not running inside an iframe, or parent is not accessible. Skipping parent communication setup.");else console.warn("CDN Script: The 'contentstorage-live-editor' URL parameter is MISSING in the script's src. This is a prerequisite. Halting further iframe-specific operations.")}();
