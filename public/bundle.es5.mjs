const e="parent-handshake-acknowledge",t="contentstorage-set-config",n="contentstorage-handshake-initiate",o="contentstorage-click-item-edit-btn",i="contentstorage-found-text-nodes",r=(e,t)=>{const n={type:e,payload:t};console.log("CDN Script: Sending message to parent:",n),window.parent.postMessage(n,"*")},a=()=>{const e=document.querySelectorAll("[data-content-key]");console.log("ELEMENTS",e),e.forEach((e=>{const t=e.dataset.contentKey;if(t){e.style.outline="1px solid #1791FF",e.style.position="relative";const n=document.createElement("div");n.setAttribute("id","contentstorage-element-label"),n.textContent=t,n.style.position="absolute",n.style.top="-15px",n.style.left="0px",n.style.color="#1791FF",n.style.fontSize="10px",n.style.zIndex="9999",n.style.pointerEvents="none";const i=(e=>{const t=document.createElement("button");t.type="button",t.style.width="30px",t.style.height="30px",t.style.position="absolute",t.style.top="-15px",t.style.right="-10px",t.style.cursor="pointer",t.style.border="1px solid #C0C0CA",t.style.backgroundColor="#EAF1F9",t.style.borderRadius="30px",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.padding="0px",t.style.color="#222225",t.style.zIndex="9999",t.onclick=t=>{t.stopPropagation(),t.preventDefault(),r(o,{contentKey:e})};const n="http://www.w3.org/2000/svg",i=document.createElementNS(n,"svg");i.setAttribute("xmlns",n),i.setAttribute("viewBox","0 0 20 20"),i.setAttribute("fill","currentColor"),i.setAttribute("width","16"),i.setAttribute("height","16");const a=document.createElementNS(n,"path");return a.setAttribute("d","M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"),i.appendChild(a),t.appendChild(i),t})(t);e.appendChild(n),e.appendChild(i)}}))};let s={highlightEditableContent:!1};const c=e=>{s={...e}},l=()=>{let e=!1;const t=e=>!!e&&(!!e.isContentEditable||t(e.parentElement)),n=n=>{const o=!!document.querySelector('[contenteditable="true"]'),{data:i,parentElement:r}=n;return i&&r&&(a=n).textContent&&/\d/.test(a.textContent)?(s=r)instanceof HTMLScriptElement||s instanceof HTMLStyleElement||s instanceof HTMLTextAreaElement||s instanceof HTMLOptionElement||"NOSCRIPT"===s.tagName?NodeFilter.FILTER_SKIP:((e,t=!1,n=!1)=>!("checkVisibility"in e)||e.checkVisibility({checkOpacity:t,checkVisibilityCSS:n}))(r)?(o&&!e&&r.isContentEditable&&(e=!0),e&&t(r)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT):NodeFilter.FILTER_SKIP:NodeFilter.FILTER_SKIP;var a,s};return(()=>{const e=[],t=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:n});for(;t.nextNode();)e.push(t.currentNode);return e})()},d=(e,t)=>{let n=!1;const o=document.body,c=["contentstorage-element-label"],d=["style","class"];for(const t of e){if(console.log("mutation",t),"attributes"===t.type&&t.attributeName&&d.includes(t.attributeName)){if(!t.target.hasAttribute("data-content-key"))continue}let e=null;if("childList"!==t.type&&"attributes"!==t.type&&"characterData"!==t.type||(e=t.target),e){let t=!1,n=e.nodeType===Node.ELEMENT_NODE?e:e.parentElement;for(;n;){if(n.id&&c.includes(n.id)){t=!0;break}n=n.parentElement}if(t)continue}n=!0;break}if(console.log("significantMutationDetected",n),n){t.disconnect();try{s.highlightEditableContent&&a();const e=l();r(i,e)}catch(e){console.error("Error during applyConfig:",e)}finally{Promise.resolve().then((()=>{t.observe(o,p)})).catch((e=>{console.error("Error re-observing after applyConfig:",e)}))}}},p={childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-content-key"]};!function(){const o=document.currentScript;if(!o)return void console.error("CDN Script: Could not determine the current script element. This is necessary to read URL parameters from the script's own URL. Ensure the script is loaded via a standard <script> tag.");const i=o.src;console.log(`CDN Script: Loaded from ${i}`);let s=null;try{s=new URL(i).searchParams.get("contentstorage-live-editor")}catch(e){return void console.error("CDN Script: Could not parse script URL. Ensure it's a valid URL.",e)}if(s)if(window.parent&&window.parent!==window){console.log("CDN Script: Running inside an iframe. Setting up communication with parent and initiating handshake.");const o=new MutationObserver(d);let i,l=!1;const u=n=>{var i;n.source===window.parent&&n.data&&(n.data.type===e?l||(l=!0,console.log("CDN Script: Received handshake acknowledgment from parent:",n.data.payload),i=n.data.payload.data.config,c(i),console.log("INITIAL CONFIG",i),i.highlightEditableContent&&a(),console.log("Applied config:",n.data.payload),console.log("Started observing DOM for mutations"),o.observe(document.body,p),console.log("CDN Script: Received handshake acknowledgment from parent:",n.data.payload),g(),console.log("CDN Script: Parent communication handshake successful. Ready for further messages.")):l?(console.log("CDN Script: Received further message from parent:",n.data),n.data.type===t&&c(n.data.payload)):console.warn("CDN Script: Received message from parent before handshake was complete. Ignoring:",n.data))},g=()=>{i&&(clearTimeout(i),i=void 0)};window.addEventListener("message",u),r(n,`Hello from iframe script (editor param: ${s}). Initiating handshake.`),i=window.setTimeout((()=>{l||(console.warn("CDN Script: Parent communication handshake timed out. Parent did not respond or acknowledge correctly."),g())}),5e3)}else console.log("CDN Script: Not running inside an iframe, or parent is not accessible. Skipping parent communication setup.");else console.warn("CDN Script: The 'contentstorage-live-editor' URL parameter is MISSING in the script's src. This is a prerequisite. Halting further iframe-specific operations.")}();
