const e="parent-handshake-acknowledge",t="contentstorage-set-config",n="contentstorage-set-highlight-content",o="contentstorage-set-hide-highlight-content",r="contentstorage-show-pending-changes",a="contentstorage-handshake-initiate",i="contentstorage-click-item-edit-btn",c="contentstorage-found-content-nodes",s=(e,t)=>{const n={type:e,payload:t};console.log("CDN Script: Sending message to parent:",n),window.parent.postMessage(n,"*")};let l=!1;const d=(e,t)=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent){const n=e.parentElement;if(n?.getAttribute("data-content-key")===t)return;const o=document.createElement("span");o.setAttribute("data-content-key",t),o.textContent=e.textContent,e.parentNode?.replaceChild(o,e)}else if(e.nodeType===Node.ELEMENT_NODE){const n=e;if(n.getAttribute("data-content-key")===t)return;n.setAttribute("data-content-key",t)}},p=e=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent){const t=e.parentElement;if(t?.hasAttribute("data-content-checked"))return;const n=document.createElement("span");n.setAttribute("data-content-checked","true"),n.textContent=e.textContent,e.parentNode?.replaceChild(n,e)}else if(e.nodeType===Node.ELEMENT_NODE){const t=e;if(t.hasAttribute("data-content-checked"))return;t.setAttribute("data-content-checked","true")}},u=(e,t)=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent?.trim()){const n=t.find((t=>("text"===t.type||"variation"===t.type)&&e.textContent?.includes(t.text)));return void(n?d(e,n.contentKey[n.contentKey.length-1]):p(e))}if(e.nodeType===Node.ELEMENT_NODE&&"IMG"===e.tagName){const n=e;console.log("content",t);const o=t.find((e=>"image"===e.type&&n.src===e.url));return void(o?d(n,o.contentKey[o.contentKey.length-1]):p(n))}if(e.nodeType===Node.ELEMENT_NODE){const t=e;if(t.hasAttribute("data-content-key")||t.hasAttribute("data-content-checked"))return}const n=Array.from(e.childNodes);for(const e of n)u(e,t)},g=(e,t)=>{if(!l){l=!0;try{e&&e?.length>0&&u(document.body,e);const n=document.querySelectorAll("[data-content-key]");console.log("elements",n),n.forEach((e=>{const n=e.dataset.contentKey,o=function(e){return e&&"IMG"===e.tagName}(e);if(console.log("contentStorageId",n),o&&!e.src)return;if(!o&&!e.textContent)return;const r=o?e.src:e.textContent;if((!window||window.memoryMap.has(r||""))&&n&&t){let t;if(o){t=document.createElement("div");const n="contentstorage-element-image-wrapper";t.setAttribute("id",n),t.style.position="relative",t.style.display="inline-block";const o=e.parentNode instanceof HTMLElement&&e.parentNode.id===n;e.parentNode&&!o&&(e.parentNode.insertBefore(t,e),t.appendChild(e)),t.style.outline="1px solid #1791FF"}else e.style.outline="1px solid #1791FF",e.style.position="relative";const r=document.createElement("div");r.setAttribute("id","contentstorage-element-label"),r.textContent=n,r.style.position="absolute",r.style.top="-15px",r.style.left="0px",r.style.color="#1791FF",r.style.fontSize="10px",r.style.zIndex="9999",r.style.pointerEvents="none";const a=(e=>{const t=document.createElement("button");t.setAttribute("id","contentstorage-element-button"),t.type="button",t.style.width="30px",t.style.height="30px",t.style.position="absolute",t.style.top="-15px",t.style.right="-10px",t.style.cursor="pointer",t.style.border="1px solid #C0C0CA",t.style.backgroundColor="#EAF1F9",t.style.borderRadius="30px",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.padding="0px",t.style.color="#222225",t.style.zIndex="9999",t.onclick=t=>{t.stopPropagation(),t.preventDefault(),s(i,{contentKey:e})};const n="http://www.w3.org/2000/svg",o=document.createElementNS(n,"svg");o.setAttribute("xmlns",n),o.setAttribute("viewBox","0 0 20 20"),o.setAttribute("fill","currentColor"),o.setAttribute("width","16"),o.setAttribute("height","16");const r=document.createElementNS(n,"path");return r.setAttribute("d","M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"),o.appendChild(r),t.appendChild(o),t})(n);o&&t?(t.appendChild(r),t.appendChild(a)):(e.appendChild(r),e.appendChild(a))}}))}finally{l=!1}}};let m={highlightEditableContent:!1};const y=e=>{m={...m,...e}},h=e=>!!e&&(!!e.isContentEditable||h(e.parentElement)),E=()=>{const e=[];console.log("NOTES",e);const t=!!document.querySelector('[contenteditable="true"]'),n=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{if(e.nodeType===Node.ELEMENT_NODE){const t=e;return console.log("IMAGE element.tagName",t.tagName),"IMG"!==t.tagName?NodeFilter.FILTER_SKIP:(console.log("image element",t.hasAttribute("data-content-checked")),t.hasAttribute("data-content-checked")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT)}if(e.nodeType===Node.TEXT_NODE){if(!e.textContent?.trim())return NodeFilter.FILTER_SKIP;const o=e.parentElement;if(!o)return NodeFilter.FILTER_REJECT;let r=o;for(;r&&r!==document.body;){if(r.hasAttribute("data-content-checked"))return NodeFilter.FILTER_REJECT;r=r.parentElement}return(n=o)instanceof HTMLScriptElement||n instanceof HTMLStyleElement||n instanceof HTMLTextAreaElement||n instanceof HTMLOptionElement||"NOSCRIPT"===n.tagName?NodeFilter.FILTER_REJECT:((e,t=!1,n=!1)=>!("checkVisibility"in e)||e.checkVisibility({checkOpacity:t,checkVisibilityCSS:n}))(o)?t&&h(o)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}var n;return NodeFilter.FILTER_SKIP}});let o;for(;o=n.nextNode();)e.push(o);return console.log("ALLAALALALALAL",e),e};function f(e){if(e.nodeType!==Node.ELEMENT_NODE)return!1;const t=e;return t.hasAttribute("data-content-key")||t.hasAttribute("data-content-checked")}const N=(e,t)=>{let n=!1;const o=document.body,r=["contentstorage-element-label"],a=["style","class"],i=e.some((e=>"childList"===e.type&&Array.from(e.addedNodes).some(f)));for(const t of e){if("childList"===t.type){if(Array.from(t.addedNodes).some(f))continue}if(i&&"childList"===t.type){if(t.removedNodes.length>0&&0===t.addedNodes.length&&Array.from(t.removedNodes).every((e=>e.nodeType===Node.TEXT_NODE)))continue}if("attributes"===t.type&&a.includes(t.attributeName||"")){if(!t.target.hasAttribute("data-content-key"))continue}const e=t.target;if(e){let t=e.nodeType===Node.ELEMENT_NODE?e:e.parentElement;for(;t;){if(t.id&&r.includes(t.id)){n=!1;break}t=t.parentElement}if(t&&r.includes(t.id))continue}n=!0;break}if(n){t.disconnect();try{const e=E();if(e.length>0){console.log("BEFORE SEND FOUND TEXT NODES",window.memoryMap),console.log("nodes!!!!!",e);const t=e.map((e=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent?.trim()){const t=window.memoryMap?.get(e.textContent),n=Array.from(t?.ids||[]),o=t?.type||"text",r=t?.variation;if(0===n.length)return null;const a={type:o,text:e.textContent.trim(),contentKey:n};return r&&(a.variation=r),a}if(console.log("(node as Element).tagName",e.tagName),e.nodeType===Node.ELEMENT_NODE&&"IMG"===e.tagName){const t=e;console.log("SRC",t.src),console.log("MEMORY",window.memoryMap);const n=Array.from(window.memoryMap?.get(t.src)?.ids||[]);return console.log("KEYS",n),0===n.length?null:{type:"image",url:t.src,alt:t.alt,contentKey:n}}return null})).filter(Boolean);console.log("structuredContent",t),s(c,{contentNodes:t});const n=m.highlightEditableContent;g(t,void 0===n||n),console.log("Significant mutation detected. Processing and sending text nodes.")}}catch(e){console.error("Error during DOM processing after mutation:",e)}finally{Promise.resolve().then((()=>{t.observe(o,T)})).catch((e=>{console.error("Error re-observing target node:",e)}))}}},T={childList:!0,subtree:!0,attributes:!0};!function(){const i=document.currentScript;if(!i)return void console.error("CDN Script: Could not determine the current script element. This is necessary to read URL parameters from the script's own URL. Ensure the script is loaded via a standard <script> tag.");const c=i.src;console.log(`CDN Script: Loaded from ${c}`);let l=null;try{l=new URL(c).searchParams.get("contentstorage-live-editor")}catch(e){return void console.error("CDN Script: Could not parse script URL. Ensure it's a valid URL.",e)}if(l)if(window.parent&&window.parent!==window){console.log("CDN Script: Running inside an iframe. Setting up communication with parent and initiating handshake.");const i=new MutationObserver(N);let c,d=!1;const p=a=>{var c,s;a.source===window.parent&&a.data&&(a.data.type===e?d||(d=!0,console.log("CDN Script: Received handshake acknowledgment from parent:",a.data.payload),s=a.data.payload.data.config,y(s),console.log("INITIAL CONFIG",s),s.highlightEditableContent&&g([],!0),console.log("Applied config:",a.data.payload),console.log("Started observing DOM for mutations"),i.observe(document.body,T),console.log("CDN Script: Received handshake acknowledgment from parent:",a.data.payload),u(),console.log("CDN Script: Parent communication handshake successful. Ready for further messages.")):d?(console.log("CDN Script: Received further message from parent:",a.data),a.data.type===t&&y(a.data.payload.data),a.data.type===n&&(y({highlightEditableContent:!0}),g([],!0)),a.data.type===o&&(y({highlightEditableContent:!1}),(()=>{const e=document.querySelectorAll("[data-content-key]"),t=document.querySelectorAll("#contentstorage-element-image-wrapper"),n=document.querySelectorAll("#contentstorage-element-label"),o=document.querySelectorAll("#contentstorage-element-button");t.forEach((e=>{const t=e.querySelector("img"),n=e.parentNode;n&&t&&(n.insertBefore(t,e),n.removeChild(e))})),e.forEach((e=>e.style="")),[...n,...o].forEach((e=>e.remove()))})()),a.data.type===r&&(c=a.data.payload.data,console.log("pendingChanges",c),c.forEach((e=>{const t=document.querySelector(`[data-content-key="${e.contentId}"]`);if(t){const n=t.childNodes;for(const t of n)if(t.nodeType===Node.TEXT_NODE&&t.textContent&&t.textContent.trim().length>0){e.value?.toString()&&e.langCountry===window.currentLanguageCode&&(t.nodeValue=e.value?.toString()||"");break}}})))):console.warn("CDN Script: Received message from parent before handshake was complete. Ignoring:",a.data))},u=()=>{c&&(clearTimeout(c),c=void 0)};window.addEventListener("message",p),s(a,`Hello from iframe script (editor param: ${l}). Initiating handshake.`),c=window.setTimeout((()=>{d||(console.warn("CDN Script: Parent communication handshake timed out. Parent did not respond or acknowledge correctly."),u())}),5e3)}else console.log("CDN Script: Not running inside an iframe, or parent is not accessible. Skipping parent communication setup.");else console.warn("CDN Script: The 'contentstorage-live-editor' URL parameter is MISSING in the script's src. This is a prerequisite. Halting further iframe-specific operations.")}();
